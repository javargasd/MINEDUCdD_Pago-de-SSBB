***************************
***************************
*Evaluación de cumplimiento
*Indicadores 1.1 y 8.1
*CdD 2023
*Javier Vargas Díaz
**************************
**************************

**************************
*0. Fijamos directorio
**************************
clear all
global ruta "D:\Onedrive\OneDrive - Ministerio de Educación\informacion\indicador1.1\"
global input "$ruta\input"
global temp "$ruta\temp"
global output "$ruta\output"

*Importamos la información
**************************
clear all
import excel "$input\semana07ab_sh.xlsx", sheet("semana07ab_sh") firstrow
rename *, low
save "$input\data_encargaturafinal", replace

************
*Encargatura
************
clear all
use "$input\data_encargaturafinal"
ta codcargo, m
unique codplaza, detail
duplicates tag codplaza, gen(a)
duplicates drop codplaza, force
keep if codcargo=="11002" | codcargo=="11007" 

ta descargo a
unique codplaza, detail

ta sitlab
keep if (sitlab=="V"| sitlab=="D"| sitlab=="E")

merge m:1 codniveduc using "$input\niveles_minedu"

drop if codniveduc=="00"
drop if codniveduc=="K0" 
drop if codniveduc=="M0" 
drop if codniveduc=="T0"

keep if (tipoplaza=="0" & subtipopla=="1") | (tipoplaza=="1" & subtipopla=="C")

keep if ( sitlab=="D" | sitlab=="V" | sitlab=="E" )

*Generando el calculo
**********************

*A nivel de UE
**************
*Denominador:
br codplaza
gen plaza=1 if marca_enc=="X"

gen den_basica=1 if (codniveduc=="A1" | codniveduc=="A2" | codniveduc=="A3" | codniveduc=="B0" | codniveduc=="D0" | codniveduc=="D1" | codniveduc=="D2" | codniveduc=="E0" | codniveduc=="E1" | codniveduc=="E2" | codniveduc=="F0") & plaza!=.

replace den_basica=0 if den_basica!=1 & sitlab=="V"

gen den_cetpro=1 if codniveduc=="L0"
replace den_cetpro=0 if den_cetpro!=1 & sitlab=="V"

replace marca_enc="." if sitlab=="V"
*Comentario: revisar los 15 que aparecen como encargados pero el marca_enc no tiene el X correspondiente
 
*Numerador
gen num_basica=1 if den_basica==1 & marca_res=="X" 
replace num_basica=0 if num_basica!=1

gen num_cetpro=1 if den_cetpro==1 & marca_res=="X"
replace num_cetpro=0 if num_cetpro!=1

rename coduge codooii
drop if _merge==1

destring codooii, replace

merge m:m codooii using "$input\padron_iged", gen(m1) force

collapse (sum) den_basica den_cetpro num_basica num_cetpro, by (codooii)
destring codooii, replace

merge 1:m codooii using "$input\padron_iged"

drop if _merge!=3
drop _merge
order codooii region ue iged tipo_entidad den_basica num_basica den_cetpro num_cetpro
/*collapse (sum) den_basica num_basica den_cetpro num_cetpro, by(ue)
merge 1:1 ue using "$input\dre_ue"
drop if _merge!=3*/

*Comentario: consultar porque OCROS no tiene informacion de encargatura
*preserve / restore
save "$input\indicador_ugel", replace

*A nivel de Region
******************
collapse (sum) den_basica num_basica den_cetpro num_cetpro, by(region)
merge 1:m region using "$input\dre_ue"
drop if tipodeiged=="UGEL EJECUTORA"
save "$input\indicador_region", replace

*Agregando region+ue
********************
clear all
use "$input\indicador_ugel"
drop if tipo_entidad=="DRE EJECUTORA" | tipo_entidad=="GRE EJECUTORA"
append using "$input\indicador_region"
sort region
/*merge 1:m codooii using "$input\dre_ue", gen(m1)
drop _merge m1*/

drop tipo_entidad iged_nompropio region_nompropio tipo_entidad_nompropio macroregion_nompropio tipodeiged _merge

merge 1:m codooii using "$input\padron_iged"
drop _merge

gen valorlogrado_basica=num_basica/den_basica
gen valorlogrado_cetpro=num_cetpro/den_cetpro
order codooii region ue iged tipo_entidad den_basica num_basica den_cetpro num_cetpro valorlogrado_basica valorlogrado_cetpro

gen numtotal=num_basica+num_cetpro
gen dentotal=den_basica+den_cetpro
gen valorlogradototal=numtotal/dentotal

*comentario: porque de las diferencias en numerador

order codooii region ue iged tipo_entidad num_basica den_basica valorlogrado_basica num_cetpro den_cetpro   valorlogrado_cetpro numtotal dentotal valorlogradototal
save "$output\resultado2022_", replace

*Graficamente:
**************
ssc install schemepack, replace
set scheme white_tableau
graph set window fontface "Arial Narrow"

gen año=2022
scatter den_basica valorlogrado_basica  if (tipo_entidad!="DRE EJECUTORA" | tipo_entidad!="GRE EJECUTORA") & año==2022, ytitle("Denominador") xtitle("Valor logrado") ylabel(, grid) xlabel(, grid) xlabel(, format(%8.0gc))
graph save "Graph" "$output\EncargaturadispersionUE2022.gph", replace

*Grafico de barras
graph hbar den_basica num_basica if (tipo_entidad!="DRE EJECUTORA" | tipo_entidad!="GRE EJECUTORA"),  title("Cobertura de plazas a encargar en Educación Básica, por región") note("Fuente: Unidad de Financiamiento por Desempeño, Minedu", span) over(region, sort(den_basica) descending) legend(label(1 "Numerador") label(2 "Denominador"))

*Puntos numerador vs denominador
graph dot (mean) num_basica den_basica, over(region, sort((mean) num_basica) descending) legend(label(1 "Numerador") label(2 "Denominador")) marker(1, msymbol(o) mfcolor(red) mlcolor(red) mlwidth(thick)) marker(2, msymbol(X) mfcolor(blue) mlcolor(blue) mlwidth(thick)) legend(label(1 "Numerador") label(2 "Denominador"))  title("Comparación Denominador vs Numerador, por región", span) note("Fuente: Unidad de Financiamiento por Desempeño, Minedu", span)
